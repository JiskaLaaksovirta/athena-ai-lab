{% extends 'partials/base.html' %}

{% block title %}{{ assignment.material.title }}{% endblock %}

{% block content %}

  <div class="page-header">
    <div>
      <h2>{{ assignment.material.title }}</h2>
      <p class="muted">Määräaika: {{ assignment.due_at|date:"d.m.Y, H:i"|default:"Ei määritetty" }}</p>
    </div>
    <a href="{% url 'dashboard' %}" class="btn">&larr; Takaisin etusivulle</a>
  </div>

  <div class="assignment-layout">
    <!-- Card 1: Assignment Content -->
    <article class="card assignment-content">
      <h3>Tehtävänanto</h3>
      <p>{{ assignment.material.content|linebreaks }}</p>
    </article>

    <!-- Card 2: Submission Area -->
    <article class="card submission-area">

      <!-- Show the form if the status is ASSIGNED or IN_PROGRESS -->
      {% if assignment.status == 'ASSIGNED' or assignment.status == 'IN_PROGRESS' %}
        <h3>Vastauksesi</h3>
        <form method="post" novalidate class="submission-form">
            {% csrf_token %}
            
            <div class="form-group">
                <label for="{{ form.response.id_for_label }}">{{ form.response.label }}</label>
                <!-- This now correctly handles pre-filling the draft -->
                <textarea name="response" id="{{ form.response.id_for_label }}">{{ form.response.value|default_if_none:"" }}</textarea>
                
                {% if form.response.errors %}
                    <div class="form-errors">
                        {% for error in form.response.errors %}<span>{{ error }}</span>{% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <!-- NEW: Two distinct buttons for the two actions -->
            <div class="card-actions">
                <button type="submit" name="save_draft" value="save" class="btn">Tallenna luonnos</button>
                <button type="submit" name="submit_final" value="submit" class="btn primary">Lähetä lopullinen vastaus</button>
            </div>
        </form>

      <!-- Show the submitted answer if the status is SUBMITTED or GRADED -->
      {% elif assignment.status == 'SUBMITTED' or assignment.status == 'GRADED' %}
        <h3>Vastaus lähetetty</h3>
        <div class="alert alert-success">
            Olet jo palauttanut tämän tehtävän.
        </div>
        
        {% with submission=assignment.submissions.first %}
            {% if submission %}
            <h4 class="muted" style="margin-top: 1.5rem;">Oma vastauksesi</h4>
            <div class="submitted-response">
                <p>{{ submission.response|linebreaks }}</p>
            </div>
            {% endif %}
        {% endwith %}
      {% endif %}
    </article>
  </div>

{% endblock content %}