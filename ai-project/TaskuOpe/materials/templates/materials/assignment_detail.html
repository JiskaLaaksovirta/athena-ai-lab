{% extends 'partials/base.html' %}

{% block title %}{{ assignment.material.title }}{% endblock %}

{% block content %}

  <div class="page-header">
    <div>
      <h2>{{ assignment.material.title }}</h2>
      <p class="muted">Määräaika: {{ assignment.due_at|date:"d.m.Y, H:i"|default:"Ei määritetty" }}</p>
    </div>
    <a href="{% url 'dashboard' %}" class="btn">&larr; Takaisin etusivulle</a>
  </div>

  <div class="assignment-layout">
    <!-- Card 1: Assignment Content -->
    <article class="card assignment-content">
      <h3>Tehtävänanto</h3>
      <p>{{ assignment.material.content|linebreaks }}</p>
    </article>

    <!-- Card 2: Submission Area -->
    <article class="card submission-area">

      {% if assignment.status == 'ASSIGNED' or assignment.status == 'IN_PROGRESS' %}
        <h3>Vastauksesi</h3>
        <form method="post" novalidate class="submission-form">
          {% csrf_token %}
          <div class="form-group">
            <label for="{{ form.response.id_for_label }}">{{ form.response.label }}</label>
            <textarea name="response" id="{{ form.response.id_for_label }}">{{ form.response.value|default_if_none:"" }}</textarea>
            {% if form.response.errors %}
              <div class="form-errors">
                {% for error in form.response.errors %}<span>{{ error }}</span>{% endfor %}
              </div>
            {% endif %}
          </div>
          <div class="card-actions">
            <button type="submit" name="save_draft" value="save" class="btn">Tallenna luonnos</button>
            <button type="submit" name="submit_final" value="submit" class="btn primary">Lähetä lopullinen vastaus</button>
          </div>
        </form>

      {% elif assignment.status == 'SUBMITTED' or assignment.status == 'GRADED' %}
        <h3>Vastaus lähetetty</h3>
        <div class="alert alert-success">
          Olet jo palauttanut tämän tehtävän.
        </div>

        {# Näytä uusin palautus #}
        {% with submission=assignment.submissions.last %}
          {% if submission %}
            <h4 class="muted" style="margin-top: 1.5rem;">Oma vastauksesi</h4>
            <div class="submitted-response">
              <p>{{ submission.response|linebreaks }}</p>
            </div>

            {% if assignment.status == 'GRADED' %}
              <section class="card" style="margin-top: 1.5rem;">
                <h4>Arviointi</h4>

                {# Arvosana 4–10 #}
                <p><strong>Arvosana:</strong>
                  {% if submission.grade %}{{ submission.grade }}{% else %}Ei arvosanaa{% endif %}
                </p>

                {# Pisteet: saadut / maksimi (näytetään siististi sen mukaan mitä on olemassa) #}
                <p>
                  <strong>Pisteet:</strong>
                  {% if submission.score and submission.max_score %}
                    {{ submission.score|floatformat:"-2" }} / {{ submission.max_score|floatformat:"-2" }}
                  {% elif submission.score %}
                    {{ submission.score|floatformat:"-2" }}
                  {% elif submission.max_score %}
                    0 / {{ submission.max_score|floatformat:"-2" }}
                  {% else %}
                    Ei pisteytetty
                  {% endif %}
                </p>

                {% if submission.feedback %}
                  <p><strong>Palaute:</strong></p>
                  <div class="teacher-feedback">
                    <p>{{ submission.feedback|linebreaks }}</p>
                  </div>
                {% endif %}
              </section>
            {% endif %}
          {% endif %}
        {% endwith %}
      {% endif %}
    </article>
  </div>

{% endblock content %}
