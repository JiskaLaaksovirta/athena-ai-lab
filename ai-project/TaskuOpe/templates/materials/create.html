{% extends "partials/base.html" %}
{% block title %}Luo uusi materiaali{% endblock %}

{% block extra_css %}
<!-- LIS√ÑTTY: Tuodaan EasyMDE-editorin tyylitiedosto -->
<link rel="stylesheet" href="https://unpkg.com/easymde/dist/easymde.min.css">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 pb-3 border-bottom taskuope-header">
        <div class="mb-3 mb-md-0">
            <h1 class="h2 taskuope-header-title mb-1">
                Luo uusi materiaali
            </h1>
            <p class="taskuope-header-subtitle">
                <span class="taskuope-badge">ü§ñ Teko√§lyn avulla</span>
                <span class="ms-2">tai manuaalisesti!</span>
            </p>
        </div>

          <!-- Takaisin materiaalin valintaan -->
  <button type="button" id="btn-back-to-type"
          class="btn btn-sm btn-outline-primary rounded-pill d-flex align-items-center gap-1">
    <i class="bi bi-puzzle"></i> Valitse materiaalin tyyppi
  </button>
    </div>
</div>

    <form method="post" novalidate>
        {% csrf_token %}
        <input type="hidden" name="structured_content_json" id="id_structured_content_json">

        {% if form.non_field_errors %}
            <div class="alert alert-danger" role="alert">{{ form.non_field_errors }}</div>
        {% endif %}

        <div class="row">
            <!-- Vasen sarake: AI-ty√∂kalut -->
            <div class="col-lg-5 col-xl-4 mb-4 mb-lg-0">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-white border-0 pb-0">
                    <h5 class="step-header step-1 mb-3">Luo sis√§lt√∂ teko√§lyll√§ (valinnainen)</h5>
                    </div>
                    <div class="card-body d-flex flex-column">
                        <div class="mb-3">
                            <label for="id_ai_prompt" class="form-label">Kirjoita aihe tai ohje</label>
                            <textarea name="ai_prompt" class="form-control" id="id_ai_prompt" rows="3" placeholder="Esim. 'Johdanto prosenttilaskentaan 7.-luokalle...'">{{ ai_prompt }}</textarea>
                        </div>

                        <div id="ops-assistant-card"  class="card p-3 mb-3">
                            <h6 class="mb-2">Opetussuunnitelma-avustin</h6>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" role="switch" id="use_ops_checkbox" name="use_ops" {% if ops_vals.use_ops %}checked{% endif %}>
                                <label class="form-check-label" for="use_ops_checkbox">K√§yt√§ OPS-kontekstia</label>
                            </div>
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <label for="ops_subject" class="form-label small">Oppiaine</label>
                                    <select name="ops_subject" id="ops_subject" class="form-select form-select-sm">
                                        <option value="">-- Valitse --</option>
                                        {% for subject_name in ops_facets.subjects %}
                                            <option value="{{ subject_name }}" {% if ops_vals.ops_subject == subject_name %}selected{% endif %}>{{ subject_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="ops_grade" class="form-label small">Luokka-aste</label>
                                    <select name="ops_grade" id="ops_grade" class="form-select form-select-sm">
                                        <option value="">-- Valitse --</option>
                                        {% for grade_name in ops_facets.grades %}
                                            <option value="{{ grade_name }}" {% if ops_vals.ops_grade == grade_name %}selected{% endif %}>{{ grade_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Valitse teko√§lyn toiminto:</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="ai_action" id="action_text" value="text" checked>
                                <label class="form-check-label" for="action_text">Luo sis√§lt√∂ehdotus (teksti)</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="ai_action" id="action_game" value="game">
                                <label class="form-check-label" for="action_game">Generoi peli</label>
                            </div>
                        </div>

                        <div id="ai-action-text-panel" class="d-grid">
                           <button type="submit" id="btn-generate-text"name="action" value="ai" class="btn btn-ai-action" formnovalidate>
                        <i class="bi bi-stars me-1"></i> Luo sis√§lt√∂ehdotus
                        </button>
                        </div>

                    <div id="ai-action-game-panel" class="d-none">
                        <div id="ai-game-tool" class="border rounded p-3">
                            <div class="mb-2">
                                <label for="ai_game_type" class="form-label">Valitse pelityyppi</label>
                                <select id="ai_game_type" class="form-select form-select-sm">
                                    <option value="quiz">Visa</option>
                                    <option value="hangman">Mysteerisana</option>
                                    <option value="memory">Muistipeli</option>
                                </select>
                            </div>
    
                            <div class="d-grid"><button type="button" id="ai_game_generate_btn" class="btn btn-sm btn-ai-action">
                            <i class="bi bi-controller me-1"></i> Generoi peli
                            </button></div>
                            <div id="ai_game_status" class="small text-muted mt-2" aria-live="polite"></div>
                        </div>
                    </div>

                        {% if ai_reply %}
                        <hr class="my-4">
                        <div>
                            <h6 class="mb-2">Teko√§lyn vastaus</h6>
                            <div class="ai-reply-panel p-3 mt-2 border rounded" style="max-height: 300px; overflow-y: auto;">
                                <pre id="ai_reply_box" style="white-space: pre-wrap; font-family: inherit; margin: 0;">{{ ai_reply }}</pre>
                            </div>
                            <button type="button" id="btn-copy-ai-reply" class="btn btn-sm btn-outline-secondary mt-2">
                                <i class="bi bi-clipboard-plus me-1"></i> Kopioi sis√§lt√∂kentt√§√§n
                            </button>
                        </div>
                        {% endif %}

                        <div id="ai-image-section">
                        <hr class="my-4">
                        <h6 class="mb-2">Kuvagenerointi</h6>
                        <div id="ai-image-tool" class="ai-image-panel border rounded p-3" data-generate-url="{% url 'generate_image' %}">
                            <div class="mb-2"><label for="ai_image_prompt" class="form-label">Kuvaus / ohje kuvalle</label><textarea id="ai_image_prompt" class="form-control" rows="2" placeholder="Esim. 'Yksinkertainen piirros pyramidista'"></textarea></div>
                            <div class="d-flex gap-2"><select id="ai_image_size" class="form-select form-select-sm"><option value="square">Neli√∂</option><option value="landscape">Vaaka</option><option value="portrait">Pysty</option></select><button type="button" id="ai_image_generate" class="btn btn-sm btn-ai-action w-100">
                            <i class="bi bi-image me-1"></i> Generoi kuva</button></div>
                            <div id="ai_image_status" class="small text-muted mt-2" aria-live="polite"></div>
                            <div id="ai_image_result" class="d-none mt-2"><img id="ai_image_preview" src="" alt="Generoitu kuva" class="img-fluid rounded border"><div class="d-grid mt-2"><button 
                                    type="button" 
                                    id="ai_image_insert" 
                                    class="btn btn-sm btn-outline-primary d-flex align-items-center gap-2"
                                    >
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-image" viewBox="0 0 16 16">
                                <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                                <path d="M2.002 1.5A1.5 1.5 0 1 1 5 0a1.5 1.5 0 0 1-3 1.5zm10.5 0a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                                <path d="M2 7h12v6H2V7z"/>
                            </svg>
                                Lis√§√§ kuva sis√§lt√∂√∂n
                                </button></div></div>
                        </div>
                    </div>
                </div>
            </div>
            </div>

            <!-- Oikea sarake: Materiaalin tiedot -->
            <div class="col-lg-7 col-xl-8">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-white border-0 pb-0">
                        <h5 class="step-header step-2 mb-3">Viimeistele ja tallenna materiaali</h5> </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3"><label for="{{ form.title.id_for_label }}" class="form-label">{{ form.title.label }}</label>{{ form.title }}<span id="error-title" class="text-danger small d-none">T√§m√§ kentt√§ on pakollinen.</span></div>
                            <div class="col-md-6 mb-3"><label for="{{ form.subject.id_for_label }}" class="form-label">{{ form.subject.label }}</label>{{ form.subject }}<span id="error-subject" class="text-danger small d-none">T√§m√§ kentt√§ on pakollinen.</span></div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3"><label for="{{ form.grade_level.id_for_label }}" class="form-label">{{ form.grade_level.label }}</label>{{ form.grade_level }}<span id="error-grade_level" class="text-danger small d-none">T√§m√§ kentt√§ on pakollinen.</span></div>
                            <div class="col-md-6 mb-3"><label for="{{ form.material_type.id_for_label }}" class="form-label">{{ form.material_type.label }}</label>{{ form.material_type }}<span id="error-material_type" class="text-danger small d-none">T√§m√§ kentt√§ on pakollinen.</span></div>
                        </div>
                        <div class="mb-3">
                            <label for="{{ form.content.id_for_label }}" class="form-label">{{ form.content.label }}</label>
                            {{ form.content }}
                            <span id="error-content" class="text-danger small d-none">T√§m√§ kentt√§ on pakollinen.</span>
                        </div>
                        <div class="d-grid mt-4">
                            <button type="submit" name="action" value="save" class="btn btn-save-material" id="save-material-button">
                            <i class="bi bi-cloud-check me-2"></i>Tallenna materiaali
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>


<!-- KIRJASTOT -->
<script src="https://unpkg.com/easymde/dist/easymde.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<!-- SIVUKOHTAINEN K√ÑYTT√ñLOGIIKKA -->
<script>
/* --- CSRF --- */
function getCookie(name){
  const value=`; ${document.cookie}`;
  const parts=value.split(`; ${name}=`);
  if(parts.length===2) return parts.pop().split(';').shift();
}

/* --- GLOBAALI EDITORI --- */
let easyMDE;

/* --- PARSINTA: poimi otsikko, aihe, luonnos --- */
function parseAiReply(raw){
  if(!raw) return {title:"",subject:"",draft:""};
  let title="";
  const m0=raw.match(/^\s*Otsikkoehdotus\s*:\s*(.+)$/mi);
  const m1=raw.match(/^\s*Otsikko\s*:\s*(.+)$/mi);
  const m2=raw.match(/^\s*#\s+(.+)$/m);
  if(m0) title=m0[1].trim(); else if(m1) title=m1[1].trim(); else if(m2) title=m2[1].trim();

    let subject = "";
    // sallii Aihe/Oppiaine + :, -, ‚Äì tai ‚Äî, ja siivoaa markdown-lihavoinnin ym.
    const s1 = raw.match(/^\s*(?:Aihe|Oppiaine)\s*(?:[:\-‚Äì‚Äî]|=)\s*(.+)$/im);
    if (s1) {
    subject = s1[1]
        .replace(/[*_`]/g, "")   // poista **, __, ``
        .replace(/\s+\(.*?\)\s*$/, "") // poista sulkeissa oleva lis√§selite lopusta
        .trim();
    }

  let draft="";
  const d=raw.match(/^\s*Luonnosteksti\s*:\s*([\s\S]*)$/mi);
  if(d){ draft=d[1].trim(); }
  else{
    let body=raw
      .replace(/^\s*Tavoitteet\s*:\s*[\s\S]*?(?=^\s*[A-Z√Ö√Ñ√ña-z√•√§√∂].*:\s*$|^\s*Luonnosteksti\s*:|$)/gmi,"")
      .replace(/^\s*Otsikkoehdotus\s*:.+$/gmi,"")
      .replace(/^\s*Otsikko\s*:.+$/gmi,"")
      .replace(/^\s*Aihe\s*:.+$/gmi,"")
      .replace(/^\s*Oppiaine\s*:.+$/gmi,"");
    draft=body.trim();
  }

  draft=draft.replace(/\n*:::\s*note\s*\n\s*:::\s*\n*/g,"\n").trim();
  return {title,subject,draft};
}

/* --- AUTOFILL otsikko/aihe + sis√§ll√∂n luonnos --- */
function autofillFromAi(){
  const aiBox=document.getElementById('ai_reply_box');
  if(!aiBox) return;
  const {title,subject,draft}=parseAiReply(aiBox.innerText||"");

  const titleEl=document.getElementById('{{ form.title.id_for_label }}');
  const subjectEl=document.getElementById('{{ form.subject.id_for_label }}');

  if(titleEl && !titleEl.value && title) titleEl.value=title;

  if(subjectEl && !subjectEl.value){
    let set=false;
    if(subject){
      const opts=subjectEl.options||[];
      for(let i=0;i<opts.length;i++){
        const txt=(opts[i].text||"").trim().toLowerCase();
        const val=(opts[i].value||"").trim().toLowerCase();
        if(txt===subject.toLowerCase() || val===subject.toLowerCase()){ subjectEl.value=opts[i].value; set=true; break; }
      }
    }
    if(!set){
      const opsSel=document.getElementById('ops_subject');
      if(opsSel && opsSel.value) subjectEl.value=opsSel.value;
    }
  }

  if(draft && easyMDE && !easyMDE.value().trim()){
    easyMDE.value(draft);
  }
}

/* --- INIT --- */
document.addEventListener('DOMContentLoaded',()=>{

  // 1) EasyMDE
  easyMDE = new EasyMDE({
    element: document.getElementById('{{ form.content.id_for_label }}'),
    spellChecker: false,
    placeholder: "Kirjoita materiaalisi sis√§lt√∂ t√§h√§n...",
    toolbar: [
      // POISTETTU "underline" joka ei ole tuettu
      "bold","italic","|","heading","|",
      "quote","unordered-list","ordered-list","|","link","|",
      {
        name:"huomio",
        action:(ed)=>{
          const cm=ed.codemirror; const sel=cm.getSelection();
          cm.replaceSelection(`\n:::note\n${sel}\n:::\n`);
        },
        className:"fa fa-exclamation-circle",
        title:"Luo huomiolaatikko"
      },
      "|","preview","side-by-side","fullscreen","|","guide"
    ],
    maxHeight:"600px",
    minHeight:"300px",

    // Render√∂i markdown -> html ja hydratoi pelit

    previewRender: (plainText, preview) => {
    const html = (window.marked && typeof window.marked.parse==='function')
        ? window.marked.parse(plainText)
        : plainText;
    preview.innerHTML = html;

    // ‚úÖ √§l√§ kaada skripti√§ jos hydrateGames puuttuu
    if (typeof window.hydrateGames === "function") {
        requestAnimationFrame(() => window.hydrateGames(preview));
    }

    return preview.innerHTML;
    }
 });

  // KIINNIT√Ñ INSTANSSI GLOBAALIKSI
  window.easyMDE = easyMDE;

  // P√§ivit√§ upotukset side-by-side -tilassa
const rehydrate = () => {
  const pv = document.querySelector('.editor-preview, .editor-preview-side');
  if (pv && typeof window.hydrateGames === "function") {
    window.hydrateGames(pv);
  }
};
  easyMDE.codemirror.on('change', () => {
    if (document.querySelector('.editor-preview, .editor-preview-side')) rehydrate();
  });

  // 2) T√§yt√§ heti jos vastaus on jo paikalla
  autofillFromAi();

  // 3) Kopioi vain luonnos -nappi
  const btnCopy=document.getElementById('btn-copy-ai-reply');
  if(btnCopy){
    btnCopy.addEventListener('click',()=>{
      const raw=document.getElementById('ai_reply_box')?.innerText||"";
      const {draft}=parseAiReply(raw);
      if(!draft) return;
      const cur=easyMDE.value();
      easyMDE.value((cur?cur+"\n\n":"")+draft);
      easyMDE.codemirror.focus();
    });
  }


    // Kuvageneroinnin toiminnot
    const imageToolRoot = document.getElementById('ai-image-tool');
    if (imageToolRoot) {
        const btnGen = document.getElementById('ai_image_generate');
        const btnIns = document.getElementById('ai_image_insert');
        const promptEl = document.getElementById('ai_image_prompt');
        const sizeEl = document.getElementById('ai_image_size');
        const statusEl = document.getElementById('ai_image_status');
        const resBox = document.getElementById('ai_image_result');
        const previewEl = document.getElementById('ai_image_preview');
        const generateUrl = imageToolRoot.dataset.generateUrl;

        btnGen.addEventListener('click', async () => {
            const prompt = (promptEl.value || '').trim();
            const size = sizeEl.value || 'square';
            if (!prompt) { statusEl.textContent = 'Anna ensin kuvaprompti.'; return; }
            //statusEl.textContent = 'Generoidaan kuvaa‚Ä¶'; -> Poistettu, lis√§tty toiminnallisuus nappiin -Mirka
            resBox.classList.add('d-none');
            previewEl.src = '';
            try {
                const resp = await fetch(generateUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
                    body: JSON.stringify({ prompt, size })
                });
                if (!resp.ok) { const txt = await resp.text(); throw new Error(`Palvelin: ${resp.status} ${txt}`); }
                const data = await resp.json();
                if (!data.image_url) { throw new Error('image_url puuttuu vastauksesta.'); }
                previewEl.src = data.image_url;
                resBox.classList.remove('d-none');
                statusEl.textContent = 'Kuva valmis.';
            } catch (err) {
                statusEl.textContent = `Virhe: ${err.message}`;
            }
            finally {
        // Spinneri nappi kuvalle t.Mirka
              btnGen.disabled = false;
              btnGen.innerHTML =
                  btnGen.dataset.originalHtml || '<i class="bi bi-image me-1"></i> Generoi kuva';
    }
        });

        btnIns.addEventListener('click', () => {
            const url = previewEl.getAttribute('src');
            if (!url) return;
            const md = `\n\n![Generoitu kuva](${url}#size-md-align-center)\n`;
            const currentContent = easyMDE.value();
            easyMDE.value(currentContent + md);
            easyMDE.codemirror.focus();
        });
    }
    
    // === OSA 3: LOMAKKEEN PERUSVALIDOINTI (ennallaan) ===
    const saveButton = document.getElementById('save-material-button');
    if (saveButton) {
        // ... (koko validointilogiikka t√§h√§n, t√§ysin sama kuin aiemmin) ...
        const fields = { /* ... */ };
        const errorSpans = { /* ... */ };
        const validateField = (key) => { /* ... */ };
        saveButton.addEventListener('click', (event) => { /* ... */ });
        for (const key in fields) { /* ... */ }
    }
    
    
    // --- OSA 4: UUSI LOGIIKKA AI-TOIMINNON VALINNALLE JA PELIN GENEROINNILLE ---
    const radioButtons = document.querySelectorAll('input[name="ai_action"]');
    const textPanel = document.getElementById('ai-action-text-panel');
    const gameGenPanel = document.getElementById('ai-action-game-panel');
    const gameToolRoot = document.getElementById('ai-game-tool');

    function toggleAiAction() {
        const selectedAction = document.querySelector('input[name="ai_action"]:checked').value;
        textPanel.classList.toggle('d-none', selectedAction !== 'text');
        gameGenPanel.classList.toggle('d-none', selectedAction !== 'game');
    }
    radioButtons.forEach(radio => radio.addEventListener('change', toggleAiAction));
    toggleAiAction();

    if (gameToolRoot) {
        const generateBtn = document.getElementById('ai_game_generate_btn');
        const statusEl = document.getElementById('ai_game_status');
        const topicTextarea = document.getElementById('id_ai_prompt');
        const gameTypeSelect = document.getElementById('ai_game_type');
        const hiddenInput = document.getElementById('id_structured_content_json');
        const difficultySelector = document.getElementById('difficulty-selector');

        // Kaappaava vartija: jos aihe puuttuu, est√§ kaikki muut klikki-handlerit (mm. spinneri-apuri) t. Mirka
        generateBtn.addEventListener('click', (e) => {
          const topic = (topicTextarea.value || '').trim();
          if (!topic) {
            e.preventDefault();
            e.stopImmediatePropagation(); // est√§√§ wireAsyncButtonBySelector-spinnerin

            statusEl.textContent = 'Kirjoita ensin aihe tai ohje ylimp√§√§n kentt√§√§n.';
            statusEl.classList.add('text-danger');

            // Varmuuden vuoksi palauta nappi heti (jos spinneri ehti muuttaa sen)
            generateBtn.disabled = false;
            generateBtn.innerHTML =
              generateBtn.dataset.originalHtml || '<i class="bi bi-controller me-1"></i> Generoi peli';
          }
        }, true); // ‚Üê capture=true

        if (gameTypeSelect && difficultySelector) {
            gameTypeSelect.addEventListener('change', () => {
                if (gameTypeSelect.value === 'quiz') {
                    difficultySelector.style.display = 'block';
                } else {
                    difficultySelector.style.display = 'none';
                }
            });
}

        generateBtn.addEventListener('click', async () => {
            const topic = (topicTextarea.value || '').trim();
            if (!topic) return;  // Vartija, pit√§isi olla jo estetty

            const gameType = gameTypeSelect.value;
            // 1. üÜï Hae valittu vaikeustaso (jos valitsin on olemassa)
            const difficulty = difficultySelector ? difficultySelector.value : null;

            statusEl.classList.remove('text-danger','text-success');
            //statusEl.textContent = 'Generoidaan peli√§, odota hetki...';
            // √Ñl√§ disabloi t√§ss√§ ‚Äì spinneri-apuri (wireAsyncButtonBySelector) tekee sen

            // jos spinneri√§ ei olisi kytketty, varmistetaan disable
            //if (!generateBtn.disabled) generateBtn.disabled = true;

            try {
                // 2. KORVAA T√ÑM√Ñ KOHTA L√ÑHETT√ÑM√Ñ√ÑN MY√ñS VAIKEUSTASO
                const response = await fetch("{% url 'generate_game_ajax' %}", {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'X-CSRFToken': getCookie('csrftoken') 
                    },
                    body: JSON.stringify({ 
                        topic: topic, 
                        game_type: gameType,
                        difficulty: difficulty //  L√§het√§ vaikeustaso
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Palvelin vastasi virheell√§ ${response.status}`);
                }

                const data = await response.json();
            
                // Tallenna pelisis√§lt√∂
                hiddenInput.value = JSON.stringify(data.game_data);
            
                // T√§yt√§ otsikko ja aihe automaattisesti
                if (data.metadata) {
                    const titleInput = document.getElementById('id_title');
                    const subjectInput = document.getElementById('id_subject');
                
                    if (data.metadata.title && titleInput) {
                        titleInput.value = data.metadata.title;
                        const errorSpan = document.getElementById('error-title');
                        if (errorSpan) errorSpan.classList.add('d-none');
                    }
                
                    if (data.metadata.subject && subjectInput) {
                        subjectInput.value = data.metadata.subject;
                        const errorSpan = document.getElementById('error-subject');
                        if (errorSpan) errorSpan.classList.add('d-none');
                    }
                }
            
                // Aseta materiaalityypiksi "peli"
                const materialTypeSelect = document.getElementById('id_material_type');
                if (materialTypeSelect) {
                    materialTypeSelect.value = 'peli';
                }
            
                statusEl.textContent = `Valmis! Peli luotu. Otsikko ja aihe t√§ytetty automaattisesti, lis√§√§ viel√§ luokka-aste.`;
                statusEl.classList.remove('text-danger');
                statusEl.classList.add('text-success');
                
            } catch (error) {
                // Virheenk√§sittely
                statusEl.textContent = `‚ùå Virhe: ${error.message}`;
                statusEl.classList.remove('text-success');
                statusEl.classList.add('text-danger');
                
            } finally {
                // Palauta nappi takaisin k√§ytt√∂√∂n aina
                generateBtn.disabled = false;
                //Lis√§tty py√∂riv√§ nappi/Vaihdettu edellisest√§ tyylist√§ pois -Mirka
                generateBtn.innerHTML = generateBtn.dataset.originalHtml || '<i class="bi bi-controller me-1"></i> Generoi peli';
            }
        });
    }

});


//---VAIHE 5 IDA ---//
// Kollapsaa koko AI-kortti (vasen palsta) ilman templaattimuutoksia

//---T√ÑH√ÑN LOPPUU TESTI JA ALKAA TOIMIVA!!!!!!!!!---//
document.addEventListener('DOMContentLoaded', () => {

  const typeSel = document.getElementById('id_material_type');

  // ====== YLEISLAYOUT (vasen AI-kortti, otsikkorivit, sis√§lt√∂, tallenna) ======
  const sections = {
    aiTools: document.querySelector('.col-lg-5.col-xl-4'),
    titleSubjectRow: (()=> {
      const t = document.getElementById('id_title');
      const s = document.getElementById('id_subject');
      if (!t || !s) return null;
      let a=t; const rows=[];
      while (a) { if (a.classList?.contains('row')) rows.push(a); a=a.parentElement; }
      let b=s;
      while (b) { if (b.classList?.contains('row') && rows.includes(b)) return b; b=b.parentElement; }
      return null;
    })(),
    gradeCol: document.getElementById('id_grade_level')?.closest('.col-md-6'),
    contentBlock: document.getElementById('{{ form.content.id_for_label }}')?.closest('.mb-3'),
    saveBlock: document.getElementById('save-material-button')?.closest('.d-grid'),
  };
  function setVisible(node, show){
    if (!node) return;
    node.style.display = show ? '' : 'none';
    node.querySelectorAll('input,select,textarea,button').forEach(el => {
      if (el === typeSel) return;
      el.disabled = !show;
    });
  }
  const layout = {
    oppimateriaali:{ ai:true, title:true, grade:true, content:true,  save:true },
    testi:         { ai:true, title:true, grade:true, content:true,  save:true },
    koe:           { ai:true, title:true, grade:true, content:true,  save:true },
    video:         { ai:true, title:true, grade:true, content:false, save:true },
    peli:          { ai:true, title:true, grade:true, content:false, save:true },
  };
  function applyLayout(){
    const val = (typeSel?.value || '').toLowerCase();
    if (!val || !layout[val]) {
      setVisible(sections.aiTools, false);
      setVisible(sections.titleSubjectRow, false);
      setVisible(sections.gradeCol, false);
      setVisible(sections.contentBlock, false);
      setVisible(sections.saveBlock, false);
      return;
    }
    const cfg = layout[val];
    setVisible(sections.aiTools, !!cfg.ai);
    setVisible(sections.titleSubjectRow, !!cfg.title);
    setVisible(sections.gradeCol, !!cfg.grade);
    setVisible(sections.contentBlock, !!cfg.content);
    setVisible(sections.saveBlock, !!cfg.save);

    // Synkkaa AI-kortin sis√§inen n√§kyvyys
    setAiModeByType();
  }

  // ====== AI-KORTIN SIS√ÑINEN LOGIIKKA (teksti vs. peli, OPS/kuva) ======
  const textPanel    = document.getElementById('ai-action-text-panel');
  const gameGenPanel = document.getElementById('ai-action-game-panel');
  const gameToolRoot = document.getElementById('ai-game-tool');
  const imageSection = document.getElementById('ai-image-section'); 
  const imageTool    = document.getElementById('ai-image-tool');
  const radioButtons = document.querySelectorAll('input[name="ai_action"]');

  function setOptionVisible(inputEl, show){
    if (!inputEl) return;
    const wrap = inputEl.closest('.form-check') || inputEl;
    wrap.classList.toggle('d-none', !show);
    wrap.toggleAttribute('inert', !show);
    inputEl.disabled = !show;
  }
  function setPanelVisibility(node, show){
    if (!node) return;
    node.classList.toggle('d-none', !show);
    node.toggleAttribute('inert', !show);
    node.setAttribute('aria-hidden', String(!show));
    node.querySelectorAll('input,select,textarea,button').forEach(el => el.disabled = !show);
  }
  function toggleAiAction(){
    const selected = document.querySelector('input[name="ai_action"]:checked')?.value;
    setPanelVisibility(textPanel, selected === 'text');
    setPanelVisibility(gameGenPanel, selected === 'game');
  }
  radioButtons.forEach(r => r.addEventListener('change', toggleAiAction));

function setAiModeByType(){
  const val   = (typeSel?.value || '').toLowerCase();
  const rText = document.getElementById('action_text');
  const rGame = document.getElementById('action_game');
  const opsCard = document.getElementById('ops-assistant-card');

  if (val === 'peli') {
    // vain peli-ty√∂kalu
    setOptionVisible(rText, false);
    setOptionVisible(rGame, true);
    if (rGame) rGame.checked = true;

    setPanelVisibility(textPanel, false);
    setPanelVisibility(gameGenPanel, true);

    // üîí OPS piiloon peliss√§
    if (opsCard) setPanelVisibility(opsCard, false);

    // Kuvaty√∂kalu piiloon peliss√§
    if (imageSection) {
      setPanelVisibility(imageSection, false);
    } else {
      const imageHeader = imageTool?.previousElementSibling?.tagName === 'H6' ? imageTool.previousElementSibling : null;
      const imageHr     = imageHeader?.previousElementSibling?.tagName === 'HR' ? imageHeader.previousElementSibling : null;
      setPanelVisibility(imageTool, false);
      if (imageHeader) setPanelVisibility(imageHeader, false);
      if (imageHr)     setPanelVisibility(imageHr, false);
    }

  } else {
    // muut tyypit: tekstity√∂kalu + OPS + kuva n√§kyviin
    setOptionVisible(rText, true);
    setOptionVisible(rGame, false);
    if (rText) rText.checked = true;

    setPanelVisibility(textPanel, true);
    setPanelVisibility(gameGenPanel, false);

    if (opsCard) setPanelVisibility(opsCard, true);

    if (imageSection) {
      setPanelVisibility(imageSection, true);
    } else {
      const imageHeader = imageTool?.previousElementSibling?.tagName === 'H6' ? imageTool.previousElementSibling : null;
      const imageHr     = imageHeader?.previousElementSibling?.tagName === 'HR' ? imageHeader.previousElementSibling : null;
      setPanelVisibility(imageTool, true);
      if (imageHeader) setPanelVisibility(imageHeader, true);
      if (imageHr)     setPanelVisibility(imageHr, true);
    }
  }

  toggleAiAction();
}

  // export ei ole v√§ltt√§m√§t√∂n, koska kaikki samassa lohkossa, mutta j√§tet√§√§n varalle:
  window.setAiModeByType = setAiModeByType;


  // ====== ENNEN VALINTAA: otsikkoteksti + tallenna-nappi ======
  (function initPreselectionUI(){
    const card = typeSel?.closest('.card');
    const headerH5 = card?.querySelector('.card-header h5');
    const saveBtn = document.getElementById('save-material-button');
    let saveWrap = saveBtn ? saveBtn.closest('.d-grid') : null;

    function showSave(show){
      if (saveWrap) saveWrap.style.display = show ? '' : 'none';
      if (saveBtn) {
        saveBtn.style.display = show ? '' : 'none';
        saveBtn.disabled = !show;
        saveBtn.setAttribute('aria-hidden', show ? 'false' : 'true');
      }
    }


    //----UUSIII----//


// ====== DYNAMINEN "VALITSE MATERIAALITYYPPI" -LAATIKKO ======
function createMaterialTypeSelector() {
  const card = typeSel?.closest('.card');
  if (!card) return;
  const header = card.querySelector('.card-header');
  const body   = card.querySelector('.card-body');
  if (!body) return;

  // Est√§ duplikaatti
  if (body.querySelector('.taskuope-material-type-selector')) return;

  // Piilota header + kaikki sis√§ll√∂t bodyssa
  if (header) {
    header.setAttribute('data-hidden-by-selector', '1');
    header.style.display = 'none';
  }
  [...body.children].forEach(el => {
    el.setAttribute('data-hidden-by-selector', '1');
    el.style.display = 'none';
  });

  // Laatikko
  const selector = document.createElement('div');
  selector.className = 'taskuope-material-type-selector';
  selector.innerHTML = `
    <div class="taskuope-material-icon"><i class="bi bi-puzzle"></i></div>
    <h5 class="taskuope-material-title">Mink√§ tyyppinen materiaali?</h5>
    <p class="taskuope-material-text">
      Valitse ensin materiaalin tyyppi ‚Äì sen mukaan saat AI-ty√∂kalut ja muokkauskent√§t.
    </p>
    <div class="taskuope-material-buttons">
      <button type="button" class="taskuope-material-btn" data-value="oppimateriaali"><i class="bi bi-book me-1"></i> Oppimateriaali</button>
      <button type="button" class="taskuope-material-btn" data-value="peli"><i class="bi bi-controller me-1"></i> Peli</button>
      <button type="button" class="taskuope-material-btn" data-value="testi"><i class="bi bi-check-circle me-1"></i> Testi</button>
      <button type="button" class="taskuope-material-btn" data-value="koe"><i class="bi bi-file-earmark-text me-1"></i> Koe</button>
    </div>
  `;
  body.appendChild(selector);

  // Klikkaukset -> aseta selectin arvo
  selector.querySelectorAll('.taskuope-material-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const value = btn.getAttribute('data-value');
      if (typeSel) {
        typeSel.value = value;
        typeSel.dispatchEvent(new Event('change', { bubbles: true }));
      }
    });
  });
}

function removeMaterialTypeSelector() {
  const card = typeSel?.closest('.card');
  if (!card) return;
  const header = card.querySelector('.card-header');
  const body   = card.querySelector('.card-body');
  if (!body) return;

  // Poista laatikko
  body.querySelector('.taskuope-material-type-selector')?.remove();

  // Palauta header + body-lapset, jotka merkittiin piilotetuiksi
  if (header && header.getAttribute('data-hidden-by-selector') === '1') {
    header.style.display = '';
    header.removeAttribute('data-hidden-by-selector');
  }
  body.querySelectorAll('[data-hidden-by-selector="1"]').forEach(el => {
    el.style.display = '';
    el.removeAttribute('data-hidden-by-selector');
  });
}

function applyPreselection(){
  const chosen = !!(typeSel?.value && String(typeSel.value).trim());
  if (chosen) {
    removeMaterialTypeSelector();
    showSave(true);
  } else {
    createMaterialTypeSelector();
    showSave(false);
  }
}


    document.querySelector('form')?.addEventListener('submit', e => { if (!typeSel?.value) e.preventDefault(); });
    typeSel?.addEventListener('change', applyPreselection);
    applyPreselection();
  })();

  // ====== YHDEN KUUNTELIJAN MALLI ======
  typeSel?.addEventListener('change', applyLayout);
  applyLayout(); // alustus
});


// Add fade effect when toggling AI panels
function setPanelVisibility(node, show) {
  if (!node) return;
  if (show) {
    node.classList.remove('d-none');
    // Trigger reflow for transition
    void node.offsetWidth;
    node.style.opacity = "0";
    node.style.transition = "opacity 0.2s ease";
    setTimeout(() => node.style.opacity = "1", 10);
  } else {
    node.style.opacity = "0";
    setTimeout(() => node.classList.add('d-none'), 200);
  }
  node.querySelectorAll('input,select,textarea,button').forEach(el => el.disabled = !show);
}

document.addEventListener('DOMContentLoaded', () => {
  const backToTypeBtn = document.getElementById('btn-back-to-type');
  const typeSel = document.getElementById('id_material_type');

  backToTypeBtn?.addEventListener('click', () => {
    if (!typeSel) return;

    // Nollaa materiaalin tyyppi
    typeSel.value = '';
    // K√§ynnist√§ oma logiikkasi (n√§ytt√§√§ ‚ÄúMink√§ tyyppinen materiaali?‚Äù -laatikon)
    typeSel.dispatchEvent(new Event('change', { bubbles: true }));

    // Vierit√§ AI-kortti n√§kyviin (vasen palsta)
    const leftCard = document.querySelector('.col-lg-5.col-xl-4 .card');
    leftCard?.scrollIntoView({ behavior: 'smooth', block: 'start' });

    // Jos sinulla on mobiilikollapsi, varmistetaan ett√§ vasen kortti aukeaa
    if (leftCard && leftCard._m?.setOpen) {
      leftCard._m.setOpen(true);
    }
  });
});


/* --- MUUTA OPS + KUVA -OSAT KOLLAPSOITUVIKSI --- */
function makeCollapsible(containerEl, headerEl, contentEls, defaultOpen=false) {
  if (!containerEl || !headerEl || !contentEls?.length) return;
  if (containerEl.dataset.collapsibleInit === '1') return; // idempotentti

  // tee klikattava header
  headerEl.classList.add('collapsible-header');
  const caret = document.createElement('i');
  caret.className = 'bi bi-chevron-down caret';
  headerEl.prepend(caret);

  // k√§√§ri sis√§lt√∂ wrapperiin
  const body = document.createElement('div');
  body.className = 'collapsible-body';
  contentEls.forEach(el => body.appendChild(el));
  headerEl.after(body);

  // tila + a11y
  const setOpen = (open) => {
    headerEl.setAttribute('aria-expanded', String(open));
    body.classList.toggle('d-none', !open);
    body.toggleAttribute('inert', !open);
    body.querySelectorAll('input,select,textarea,button').forEach(n => n.disabled = !open);
  };

  headerEl.tabIndex = 0;
  headerEl.addEventListener('click', () => setOpen(headerEl.getAttribute('aria-expanded') !== 'true'));
  headerEl.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); headerEl.click(); }
  });

  // aloitustila
  setOpen(!!defaultOpen);

  containerEl.dataset.collapsibleInit = '1';
  containerEl._collapsible = { setOpen, body, headerEl };
}

function initOpsCollapsible(defaultOpen=false) {
  const opsCard = document.getElementById('ops-assistant-card');
  if (!opsCard) return;
  const h6 = opsCard.querySelector('h6');
  if (!h6) return;

  // kaikki h6:n j√§lkeiset lapset sis√§ll√∂ksi (form-switch + rivit)
  const chunks = [];
  let n = h6.nextElementSibling;
  while (n) { chunks.push(n); n = n.nextElementSibling; }
  if (chunks.length) makeCollapsible(opsCard, h6, chunks, defaultOpen);
}

function initImageCollapsible(defaultOpen=false) {
  const tool = document.getElementById('ai-image-tool');
  if (!tool) return;
  // Header on toolia edelt√§v√§ <h6>
  const h6 = (tool.previousElementSibling?.tagName === 'H6') ? tool.previousElementSibling : null;
  if (!h6) return;
  makeCollapsible(tool.parentElement || tool, h6, [tool], defaultOpen);
}

/* --- kytke n√§kyvyys materiaalityypin mukaan --- */
function showTextToolsCollapsed() {
  // n√§ytt√§√§ OPS + Kuva mutta KIINNI
  initOpsCollapsible(false);
  initImageCollapsible(false);
  // jos jo alustettu aiemmin ja olivat auki -> sulje
  const opsCard = document.getElementById('ops-assistant-card');
  if (opsCard?._collapsible) opsCard._collapsible.setOpen(false);
  const tool = document.getElementById('ai-image-tool');
  const toolHost = tool?.parentElement;
  if (toolHost?._collapsible) toolHost._collapsible.setOpen(false);

  // varmista ett√§ ne ovat n√§kyviss√§ (ei d-none), jos setAiModeByType piilotti
  opsCard?.classList.remove('d-none');
  (toolHost || tool)?.classList.remove('d-none');
  opsCard?.removeAttribute('inert');
  (toolHost || tool)?.removeAttribute('inert');
  opsCard?.querySelectorAll('input,select,textarea,button').forEach(n => n.disabled = false);
  (toolHost || tool)?.querySelectorAll('input,select,textarea,button').forEach(n => n.disabled = false);
}

function hideTextToolsCompletely() {
  // piiloon kun tyyppi = "peli"
  const opsCard = document.getElementById('ops-assistant-card');
  const tool = document.getElementById('ai-image-tool');
  const toolHost = tool?.parentElement;
  if (opsCard) { opsCard.classList.add('d-none'); opsCard.setAttribute('inert',''); }
  if (toolHost) { toolHost.classList.add('d-none'); toolHost.setAttribute('inert',''); }
}

/* --- integrointi olemassa olevaan setAiModeByTypeen --- */
/* Jos sinulla on jo window.setAiModeByType, kytke n√§m√§ loppuun: */
(function hookSetAiModeByType(){
  const original = window.setAiModeByType;
  window.setAiModeByType = function(){
    // aja alkuper√§inen n√§kyvyyslogiikkasi
    if (typeof original === 'function') original();

    const typeSel = document.getElementById('id_material_type');
    const val = (typeSel?.value || '').toLowerCase();

    if (val === 'peli') {
      hideTextToolsCompletely();
    } else {
      // muut tyypit: n√§yt√§ mutta kollapsoi (oletuksena kiinni)
      showTextToolsCollapsed();
    }
  };
})();

/* ensialustus DOM readyll√§, jos tyyppi jo valittuna */
document.addEventListener('DOMContentLoaded', () => {
  const typeSel = document.getElementById('id_material_type');
  if (!typeSel || !window.setAiModeByType) return;

  // alusta kollapsoitavat rakenteet kerran (oletus: ei-¬≠peli ‚Üí kiinni)
  initOpsCollapsible(false);
  initImageCollapsible(false);

  // aja tyyppilogiikka heti & muutoksissa
  window.setAiModeByType();
  typeSel.addEventListener('change', () => window.setAiModeByType());
});


</script>

<script>
  /*Py√∂riv√§t napit*/
document.addEventListener('DOMContentLoaded', () => {
  // Yleinen: lukitse submit-nappi ja n√§yt√§ spinneri, mutta anna natiivin submitin l√§hte√§.
  function wireSubmitButtonBySelector(selector, loadingLabel) {
    const btn = document.querySelector(selector);
    if (!btn) return;
    const form = btn.form || btn.closest('form');
    if (!form) return;

    form.addEventListener('submit', (e) => {
      const submitter = e.submitter || document.activeElement;
      if (submitter !== btn) return;             // reagoi vain oikeaan nappiin
      if (btn.disabled) return;

      btn.dataset.originalHtml = btn.dataset.originalHtml || btn.innerHTML;
      // Lukitse vasta seuraavassa tikiss√§ ‚Üí ei est√§ natiivia submitia.
      setTimeout(() => {
        btn.disabled = true;
        btn.innerHTML =
          '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>' +
          loadingLabel;
      }, 0);
    });
  }

  // Yleinen: lukitse asynkroninen (AJAX/fetch) nappi heti klikatessa ja n√§yt√§ spinneri.
  // Palautus tehd√§√§n kyseisen napin omassa "finally"-lohkossa.
  function wireAsyncButtonBySelector(selector, loadingLabel) {
    const btn = document.querySelector(selector);
    if (!btn) return;

    btn.addEventListener('click', () => {
      if (btn.disabled) return;
      btn.dataset.originalHtml = btn.dataset.originalHtml || btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML =
        '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>' +
        loadingLabel;
    });
  }

  // 1) AI-tekstiehdotus (lomakesubmit)
  wireSubmitButtonBySelector('#btn-generate-text', 'Luodaan‚Ä¶');

  // 2) Kuvagenerointi (fetch/AJAX)
  wireAsyncButtonBySelector('#ai_image_generate', 'Generoidaan‚Ä¶');

  // 3) Pelin generointi (fetch/AJAX)
  wireAsyncButtonBySelector('#ai_game_generate_btn', 'Luodaan peli‚Ä¶');
});
</script>

{% endblock %}