{# templates/materials/add_image.html #}
{% extends 'partials/base.html' %}
{% block title %}Lisää kuva{% endblock %}
{% block content %}
<div class="container-fluid">
  <h1 class="h4">Lisää kuva: {{ material.title }}</h1>

  {# Näytä Django-viestit #}
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags|default:'info' }} mb-3">{{ message }}</div>
    {% endfor %}
  {% endif %}

  <form id="addImgForm" method="post" enctype="multipart/form-data" class="card p-3">
    {% csrf_token %}

    <div class="mb-3">
      <label class="form-label">Lataa kuva</label>
      {{ form.upload }}  {# input[type=file] #}
      <div class="form-text">Voit myös generoida kuvan alla ja se täytetään tähän automaattisesti.</div>
    </div>

    <div class="text-center my-2">— tai —</div>

    <div class="mb-3">
      <label class="form-label">Generoi kuva (prompt)</label>
      {{ form.gen_prompt }}
      <div class="d-flex gap-2 mt-2">
        <select id="genSize" class="form-select" style="max-width:240px">
          <option value="square">Neliö (1024×1024)</option>
          <option value="landscape">Vaaka (1792×1024)</option>
          <option value="portrait">Pysty (1024×1792)</option>
        </select>
        <button type="button" id="genBtn" class="btn btn-secondary">Generoi kuva</button>
      </div>
      <div id="genMsg" class="form-text mt-2"></div>
      <img id="genPreview" class="img-fluid mt-2 d-none rounded border" alt="Esikatselu">
    </div>

    <div class="mb-3">
      <label class="form-label">Kuvateksti</label>
      {{ form.caption }}
    </div>

    <button class="btn btn-primary">Tallenna</button>
  </form>
</div>

<script>
(function(){
  const form = document.getElementById('addImgForm');
  const genBtn = document.getElementById('genBtn');
  const genSize = document.getElementById('genSize');
  const genMsg  = document.getElementById('genMsg');
  const genPreview = document.getElementById('genPreview');

  // hae viite tiedostokenttään (Django form field name = "upload")
  const fileInput = form.querySelector('input[type="file"][name$="upload"]');
  const promptInput = form.querySelector('[name$="gen_prompt"]');

  function getCsrfToken() {
    const m = document.cookie.match(/csrftoken=([^;]+)/);
    return m ? m[1] : '';
  }

  genBtn?.addEventListener('click', async () => {
    const prompt = (promptInput?.value || '').trim();
    const size = genSize.value;

    genMsg.textContent = 'Generoidaan…';
    genPreview.classList.add('d-none');
    genPreview.removeAttribute('src');

    if (!prompt) {
      genMsg.textContent = 'Anna generointikehote.';
      return;
    }

    try {
      const res = await fetch("{% url 'generate_image' %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCsrfToken(),
        },
        body: JSON.stringify({ prompt, size }),
      });
      const data = await res.json().catch(() => ({}));

      if (!res.ok) {
        genMsg.textContent = data.error || `Virhe (${res.status}).`;
        return;
      }
      if (!data.image_url) {
        genMsg.textContent = 'Paluu ei sisältänyt image_url-kenttää.';
        return;
      }

      // Näytä esikatselu (cache-buster)
      const url = data.image_url + `?t=${Date.now()}`;
      genPreview.src = url;
      genPreview.classList.remove('d-none');
      genMsg.textContent = data.placeholder
        ? 'Näytetään placeholder (API-avain puuttuu/virhe).'
        : 'Kuva valmis.';

      // Lataa kuva Blobiksi ja täytä file input automaattisesti
      const imgRes = await fetch(url);
      const blob = await imgRes.blob();
      const file = new File([blob], 'generated.png', { type: blob.type || 'image/png' });
      const dt = new DataTransfer();
      dt.items.add(file);
      fileInput.files = dt.files; // nyt "Tallenna" lähettää generoidun kuvan

    } catch (e) {
      genMsg.textContent = `Kutsu epäonnistui: ${e}`;
    }
  });
})();
</script>
{% endblock %}

