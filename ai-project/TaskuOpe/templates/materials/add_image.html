{% extends 'partials/base.html' %}
{% block title %}Lisää kuva{% endblock %}
{% block content %}
<div class="container-fluid">
  <form id="addImgForm" method="post" enctype="multipart/form-data" class="card shadow-sm">
      <div class="card-body p-4">
        {% csrf_token %}
        <input type="hidden" name="ai_image_size" id="id_ai_image_size" value="1024x1024">
        {# ^^^ LISÄTTY PIILOKENTTÄ KUVAN KOON VÄLITTÄMISEKSI PALVELIMELLE ^^^ #}

        <h5 class="card-title mb-4 border-bottom pb-2">
          Materiaali: <span class="fw-normal">{{ material.title }}</span>
        </h5>
        {# Näytä mahdolliset virheviestit #}
        {% if form.non_field_errors %}
          <div class="alert alert-danger">{{ form.non_field_errors }}</div>
        {% endif %}

      <div class="mb-3">
            <label for="{{ form.upload.id_for_label }}" class="form-label fw-bold">{{ form.upload.label }}</label>
            {{ form.upload }} {# TÄMÄ ON TIEDOSTOKENTTÄ #}
            {# === LISÄTTY ESKATSELUALUE === #}
            <div class="mt-2">
              <img id="uploadPreview" src="#" alt="Ladatun kuvan esikatselu" class="img-fluid rounded border d-none" style="max-height: 200px;">
              <small id="uploadPreviewMsg" class="form-text d-none text-muted">Ladatun kuvan esikatselu.</small>
            </div>
            {# === LISÄYS PÄÄTTYY === #}
            <div class="form-text mt-1">Voit myös generoida kuvan alla, jolloin se täytetään tähän kenttään automaattisesti.</div>
          </div>

          <div class="text-center my-3 text-muted">— tai —</div>

          <div class="mb-3"> <label for="{{ form.gen_prompt.id_for_label }}" class="form-label fw-bold">{{ form.gen_prompt.label }}</label>
        {{ form.gen_prompt }}
      </div>

      <div class="mb-3 d-flex gap-2">
          <select id="genSize" class="form-select" style="max-width: 240px;">
             <option value="1024x1024">Neliö (1024x1024)</option>
             <option value="1792x1024">Vaaka (1792x1024)</option>
             <option value="1024x1792">Pysty (1024x1792)</option>
          </select>
          <button type="button" id="genBtn" class="btn btn-secondary">Generoi kuva</button>
      </div>
      <div id="genMsg" class="form-text mt-2" aria-live="polite"></div>
      <img id="genPreview" class="img-fluid mt-2 d-none rounded border" alt="Generoidun kuvan esikatselu">

          
          <hr class="my-4">

          <div class="d-grid">
            <button type="submit" class="btn btn-primary">Tallenna ja lisää kuva sisältöön</button>
          </div>

        </div>
      </form>
    </div>
  </div>
</div>

<script>
(function(){
  // --- ELEMENTIT ---
  const form = document.getElementById('addImgForm');
  const genBtn = document.getElementById('genBtn');
  const genSize = document.getElementById('genSize');
  const genMsg = document.getElementById('genMsg');
  const genPreview = document.getElementById('genPreview'); // Esikatselu generoidulle kuvalle
  const fileInput = form.querySelector('input[type="file"][name$="upload"]'); // Tiedoston valintakenttä
  const previewImage = document.getElementById('uploadPreview'); // Esikatselu ladatulle kuvalle
  const previewMsg = document.getElementById('uploadPreviewMsg');
  const promptInput = form.querySelector('textarea[name$="gen_prompt"]');
  const hiddenSizeInput = document.getElementById('id_ai_image_size');

  // --- APUFUNKTIOT ---
  function getCsrfToken() {
    const m = document.cookie.match(/csrftoken=([^;]+)/);
    return m ? m[1] : '';
  }

  // --- TAPAHTUMANKUUNTELIJAT ---

  // 1. Päivitä piilokenttä koon vaihtuessa (AI-generointia varten)
  genSize?.addEventListener('change', () => {
    if (hiddenSizeInput) hiddenSizeInput.value = genSize.value;
  });

  // 2. AI-kuvan generointi napin painalluksesta
  genBtn?.addEventListener('click', async () => {
    const prompt = (promptInput?.value || '').trim();
    const size = genSize.value;

    // Aseta piilokenttä
    if (hiddenSizeInput) hiddenSizeInput.value = size;

    // Tyhjennä vanhat esikatselut ja viestit
    genMsg.textContent = 'Generoidaan…';
    genPreview.classList.add('d-none');
    genPreview.src = '';
    previewImage?.classList.add('d-none'); // Piilota myös paikallinen esikatselu
    previewMsg?.classList.add('d-none');

    if (!prompt) {
      genMsg.textContent = 'Anna generointikehote.';
      return;
    }

    try {
      // Lähetä pyyntö kuvan generoinnista
      const res = await fetch("{% url 'generate_image' %}", {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken() },
        body: JSON.stringify({ prompt, size }),
      });
      const data = await res.json().catch(() => ({}));

      if (!res.ok) {
        throw new Error(data.error || `Virhe (${res.status}).`);
      }
      if (!data.image_url) {
        throw new Error('Paluu ei sisältänyt image_url-kenttää.');
      }

      // Lataa generoitu kuva ja aseta se fileInputiin
      const url = data.image_url + `?t=${Date.now()}`; // Lisää aikaleima välimuistin ohittamiseksi

      // Näytä generoitu kuva sen omassa esikatselussa
      genPreview.src = url;
      genPreview.classList.remove('d-none');
      genMsg.textContent = data.placeholder ? 'Näytetään placeholder (API-avain puuttuu/virhe).' : 'Kuva valmis.';

      // Muunna URL File-objektiksi ja aseta se fileInput-kenttään
      const imgRes = await fetch(url);
      if (!imgRes.ok) throw new Error(`Kuvan ${url} lataus epäonnistui (${imgRes.status})`);
      const blob = await imgRes.blob();
      const file = new File([blob], 'generated.png', { type: blob.type || 'image/png' });
      const dt = new DataTransfer();
      dt.items.add(file);
      if (fileInput) fileInput.files = dt.files;

    } catch (e) {
      genMsg.textContent = `Kutsu epäonnistui: ${e.message}`;
      // Nollaa fileInput virhetilanteessa
      if (fileInput) fileInput.value = '';
    }
  });

  // 3. Paikallisen tiedoston esikatselu
  if (fileInput && previewImage && previewMsg) {
    fileInput.addEventListener('change', function(event) {
      const file = event.target.files[0];

      // Tyhjennä AI-generoinnin esikatselu, jos käyttäjä valitsee tiedoston
      genPreview?.classList.add('d-none');
      if(genMsg) genMsg.textContent = '';

      if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();

        reader.onload = function(e) {
          previewImage.src = e.target.result;
          previewImage.classList.remove('d-none'); // Näytä kuva
          previewMsg.classList.remove('d-none');   // Näytä viesti
        }
        reader.readAsDataURL(file); // Lue tiedosto Data URL:na
      } else {
        // Jos tiedosto ei ole kuva tai valinta peruttiin
        previewImage.src = '#';
        previewImage.classList.add('d-none'); // Piilota kuva
        previewMsg.classList.add('d-none');   // Piilota viesti
      }
    });
  }

  // --- ALUSTUS ---
  // Varmista, että piilokentän arvo on asetettu sivun latautuessa
  if (hiddenSizeInput && genSize) {
     hiddenSizeInput.value = genSize.value;
  }

})(); // Itse-suorittuva funktio päättyy
</script>
{% endblock %}