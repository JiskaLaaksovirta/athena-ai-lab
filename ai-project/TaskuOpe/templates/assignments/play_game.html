{% extends 'partials/base.html' %}
{% load static %}

{% block title %}Peli: {{ assignment.material.title }}{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'games/game.css' %}">
{% endblock %}

{% block content %}
<script>document.body.classList.add('game-page');</script>

<script id="game-data" type="application/json">
    {{ game_data_json|safe }}
</script>

<div id="game-info" 
     data-game-type="{{ game_type }}"
     data-completion-url="{% url 'complete_game_ajax' assignment_id=assignment.id %}">
</div>

<!-- Canvas tausta -->
<canvas id="space-canvas"></canvas>

<button id="btnToggleBackground" class="btn btn-sm btn-outline-secondary" 
        style="position: fixed; bottom: 20px; right: 20px; z-index: 1000;">
    ‚è∏Ô∏è Pys√§yt√§ tausta
</button>

<div class="container-fluid px-3 px-lg-4 py-4" style="position: relative; z-index: 1;">
    <!-- Otsikko -->
    <div class="row justify-content-center mb-4">
        <div class="col-12 col-xl-10">
            <div class="card text-center p-3">
                <h1 class="main-title">üöÄ {{ assignment.material.title }} üöÄ</h1>
                <p class="main-subtitle mb-2">Aihe: {{ assignment.material.subject }}</p>
                
                <!-- Ohjeet-nappi -->
                <div class="mt-2">
                    <button class="btn btn-sm btn-outline-light" type="button" 
                            data-bs-toggle="collapse" 
                            data-bs-target="#gameInstructions" 
                            aria-expanded="false" 
                            aria-controls="gameInstructions">
                        <i class="bi bi-info-circle me-1"></i> N√§yt√§ ohjeet
                    </button>
                </div>
                
                <!-- Ohjeet (collapsible) -->
                <div class="collapse mt-3" id="gameInstructions">
                    <div class="card card-body text-start" 
                         style="background-color: rgba(30, 41, 90, 0.8); border-color: var(--border-color);">
                        <h5 class="mb-2">
                            <i class="bi bi-lightbulb me-2"></i>Pelin ohjeet
                        </h5>
                        <div id="instructions-content">
                            <!-- Ohjeet t√§ytet√§√§n JavaScriptill√§ pelin tyypin mukaan -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- VISA-PELI: Pelilauta + Kysymykset -->
    <div class="row g-3 g-lg-4 justify-content-center">
        <!-- Pelilauta vasemmalla isolla n√§yt√∂ll√§ -->
        <div class="col-12 col-lg-7 col-xl-6">
            <div id="quiz-board-card" class="card p-0 overflow-hidden d-none">
                <div class="game-board-container">
                    <svg id="boardSvg" class="board-svg" viewBox="0 0 1200 675"></svg>
                    <div id="start-image-container">
                        <img id="start-image" src="{% static 'images/start-image.png' %}" alt="Pelin aloituskuva">
                    </div>
                    <div id="hero" class="hero">
                        <img src="{% static 'images/mascot.png' %}" alt="Pelihahmo">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Kysymykset oikealla isolla n√§yt√∂ll√§ -->
        <div class="col-12 col-lg-5 col-xl-4">
            <div id="quiz-card" class="card d-none">
                <div class="card-body p-3 p-md-4">
                    <div id="game">
                        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                            <span class="badge">Pisteet: <strong id="score">0</strong></span>
                            <span id="levelBadge" class="badge"></span>
                            <span class="badge">Aika: <strong id="timer">‚Äî</strong></span>
                        </div>
                        <h4 id="question" class="mb-3 text-center"></h4>
                        <div id="choices" class="d-grid gap-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- HIRSIPUU -->
    <div class="row g-3 justify-content-center">
        <div class="col-12 col-lg-10 col-xl-8">
            <div id="hangman-card" class="card d-none">
                <div class="card-body p-3 p-md-4">
                    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                        <span class="badge">Yrityksi√§ j√§ljell√§: <strong id="hmTriesLeft">7</strong></span>
                        <span class="badge">Pisteet: <strong id="hmScore">0</strong></span>
                    </div>
                    <div id="hmStickman" class="text-center mb-3" style="font-size: 3rem; min-height: 150px;" aria-live="polite">üòä</div>
                    <div id="hmMasked" class="text-center mb-4" style="font-size: 2rem; letter-spacing: 0.15em; font-weight: 700;" aria-live="polite">_ _ _ _</div>
                    <div id="hmLetters" class="d-flex flex-wrap gap-2 justify-content-center"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- MUISTIPELI -->
    <div class="row g-3 justify-content-center">
        <div class="col-12 col-lg-10 col-xl-8">
            <div id="memory-card" class="card d-none">
                <div class="card-body p-3 p-md-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="badge">Yrityksi√§: <strong id="mmTries">0</strong></span>
                        <span class="badge">Pareja: <strong id="mmPairs">0</strong> / <strong id="mmTotal">0</strong></span>
                    </div>
                    <div id="mmGrid"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Latausn√§kym√§ -->
<div id="loading-overlay" class="game-overlay">
    <div class="game-overlay-content">
        <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Ladataan...</span>
        </div>
        <p class="overlay-message">Ladataan peli√§...</p>
    </div>
</div>

<!-- ARIA live region ruudunlukijoille -->
<div id="game-announcer" class="visually-hidden" aria-live="polite" aria-atomic="true"></div>

<script src="{% static 'games/game.js' %}"></script>

<script>
// T√§yt√§ pelin ohjeet dynaamisesti
document.addEventListener('DOMContentLoaded', function() {
    const gameData = JSON.parse(document.getElementById('game-data').textContent);
    const instructionsContent = document.getElementById('instructions-content');
    
    let instructions = '';
    
    if (gameData.questions) {
        // ==================== VISA ====================
        instructions = `
            <p><strong>üéØ Tavoite:</strong> Vastaa kysymyksiin ja etene pelilaudalla maaliin!</p>
            <ul class="mb-2">
                <li>Lue kysymys huolellisesti</li>
                <li>Valitse oikea vastaus vaihtoehdoista</li>
                <li>Oikeat vastaukset viev√§t sinut eteenp√§in pelilaudalla</li>
                <li>V√§√§r√§t vastaukset eiv√§t vie eteenp√§in</li>
                <li>Tavoitteena on p√§√§st√§ maaliin mahdollisimman monella oikealla vastauksella</li>
            </ul>
            <p class="mb-0"><strong>üí° Vinkki:</strong> Lue kysymykset huolellisesti ennen vastaamista!</p>
        `;
    } else if (gameData.word || gameData.words) {
        // ==================== HIRSIPUU ====================
        instructions = `
            <p><strong>üîç Tavoite:</strong> Arvaa piilotettu sana ennen kuin mies hirtet√§√§n!</p>
            <ul class="mb-2">
                <li>Valitse kirjaimia yksi kerrallaan</li>
                <li>Jos kirjain on sanassa, se ilmestyy oikealle paikalleen</li>
                <li>Jos kirjainta ei ole sanassa, menet√§t yhden yrityksen</li>
                <li>Sinulla on 7 yrityst√§ arvata sana oikein</li>
                <li>Peli p√§√§ttyy, kun arvaat sanan tai yritykset loppuvat</li>
            </ul>
            <p class="mb-0"><strong>üí° Vinkki:</strong> Aloita yleisimmist√§ kirjaimista kuten A, I, E, N!</p>
        `;
    } else if (gameData.pairs) {
        // ==================== MUISTIPELI ====================
        instructions = `
            <p><strong>üîç Tavoite:</strong> L√∂yd√§ kaikki korttien parit!</p>
            <ul class="mb-2">
                <li>Klikkaa kortteja paljastaaksesi niiden sis√§ll√∂n</li>
                <li>Yrit√§ muistaa, miss√§ kukin kortti on</li>
                <li>L√∂yd√§ kaksi yhteensopivaa korttia muodostaaksesi parin</li>
                <li>Kun l√∂yd√§t parin, kortit j√§√§v√§t n√§kyviin</li>
                <li>Peli p√§√§ttyy, kun kaikki parit on l√∂ydetty</li>
            </ul>
            <p class="mb-0"><strong>üí° Vinkki:</strong> Keskity muistamaan korttien paikkoja!</p>
        `;
    } else {
        // ==================== VIRHETILANNE ====================
        instructions = '<p class="text-warning">‚ö†Ô∏è Ohjeiden latauksessa tapahtui virhe...</p>';
    }
    
    // Aseta ohjeet n√§kyviin
    instructionsContent.innerHTML = instructions;
});
</script>

{% endblock %}