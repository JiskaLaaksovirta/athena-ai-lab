{% extends 'partials/base.html' %}
{% load static %}

{% block title %}Kaikki palautukset{% endblock %}

{% block content %}
<div class="container-fluid">

  <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-4 border-bottom pb-3">
    <h1 class="h2 mb-0">Kaikki palautukset ja tehtävännot</h1>
    <div class="d-flex gap-2">
      <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-1"></i> Takaisin etusivulle
      </a>
      {# POISTETTU CSV-LATAUSPAINIKE TÄSTÄ #}
    </div>
  </div>

  <div style="max-width: 800px;" class="mb-4">
    <form method="get" class="row g-3 align-items-end p-3 rounded border">
      <div class="col-md">
        <label for="subject-filter" class="form-label fw-bold">Suodata aiheen mukaan</label>
        <select name="subject" id="subject-filter" class="form-select">
          <option value="">Kaikki aiheet</option>
          {% for subject in subjects %}
            <option value="{{ subject }}" {% if subject == selected_subject %}selected{% endif %}>
              {{ subject }}
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-auto">
        <div class="d-flex gap-2">
          <button type="submit" class="btn btn-primary">Suodata</button>
          {# KORJATTU LINKKI osoittamaan oikeaan näkymään (tämä listaussivu) ilman suodattimia #}
          <a href="{% url 'all_submissions_list' %}" class="btn btn-outline-secondary">Tyhjennä</a>
        </div>
      </div>
    </form>
  </div>

  <section class="assignments-list mb-5">
    <div class="card border-secondary">
      <div class="card-header bg-secondary bg-opacity-10">
        <button class="btn btn-link w-100 text-start text-decoration-none p-0"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#assignmentsCollapse"
                aria-expanded="false" {# Oletuksena kiinni #}
                aria-controls="assignmentsCollapse">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
              Tehtävät
              <span class="badge bg-secondary ms-2">{{ assignments.paginator.count }}</span> {# Näytä kokonaismäärä sivutuksesta #}
            </h5>
            <i class="bi bi-chevron-down"></i>
          </div>
        </button>
      </div>

      <div class="collapse" id="assignmentsCollapse"> {# Oletuksena kiinni #}
        <div class="card-body p-0">

          {% if assignments %}
          <div class="table-responsive">
            <table class="table table-hover align-middle tasks mb-0"> {# Poistettu mb-0 jos sivutus tulee perään #}
              <thead class="table-light">
                <tr>
                  <th scope="col">Oppilas</th>
                  <th scope="col">Materiaali</th>
                  <th scope="col">Määräaika</th>
                  <th scope="col">Tila</th>
                  <th scope="col">Toiminnot</th>
                </tr>
              </thead>
              <tbody>
                {% for assignment in assignments %} {# Käytä sivutettua listaa #}
                <tr>
                  <td data-label="Oppilas">{{ assignment.student.get_full_name|default:assignment.student.username }}</td>
                  <td data-label="Materiaali">{{ assignment.material.title }}</td>
                  <td data-label="Määräaika">{{ assignment.due_at|date:"d.m.Y H.i"|default:"—" }}</td>
                  <td data-label="Tila">
                    <span class="badge
                      {% if assignment.status == 'GRADED' %}bg-success
                      {% elif assignment.status == 'SUBMITTED' %}bg-primary
                      {% elif assignment.status == 'IN_PROGRESS' %}bg-warning text-dark {# Lisätty text-dark luettavuuden parantamiseksi #}
                      {% else %}bg-secondary{% endif %}">
                      {{ assignment.get_status_display }}
                    </span>
                  </td>
                  <td data-label="Toiminnot">
                    {% if assignment.status in 'SUBMITTED,GRADED' %}
                      {% with sub=assignment.submissions.last %}
                        {% if sub %}
                          <a href="{% url 'grade_submission' submission_id=sub.id %}"
                             class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-pencil-square me-1"></i> Arvioi
                          </a>
                        {% endif %}
                      {% endwith %}
                    {% else %}
                      <span class="text-muted small">Ei palautusta</span>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          {% if assignments.has_other_pages %}
          <nav aria-label="Sivunumerot" class="border-top pt-3 px-3"> {# Lisätty vähän pehmustetta #}
            <ul class="pagination justify-content-center my-0"> {# Poistettu my-3 #}
              {% if assignments.has_previous %}
                <li class="page-item">
                  {# Linkit sisältävät nyt myös subject-suodattimen #}
                  <a class="page-link" href="?page=1{% if q %}&q={{ q|urlencode }}{% endif %}{% if status %}&status={{ status|urlencode }}{% endif %}{% if selected_subject %}&subject={{ selected_subject|urlencode }}{% endif %}">
                    «
                  </a>
                </li>
                <li class="page-item">
                  <a class="page-link"
                     href="?page={{ assignments.previous_page_number }}{% if q %}&q={{ q|urlencode }}{% endif %}{% if status %}&status={{ status|urlencode }}{% endif %}{% if selected_subject %}&subject={{ selected_subject|urlencode }}{% endif %}">
                    ‹
                  </a>
                </li>
              {% else %}
                <li class="page-item disabled"><span class="page-link">«</span></li>
                <li class="page-item disabled"><span class="page-link">‹</span></li>
              {% endif %}

              {# Näytä muutama sivu nykyisen ympäriltä (valinnainen parannus) #}
              {% for num in assignments.paginator.page_range %}
                {% if assignments.number == num %}
                  <li class="page-item active" aria-current="page"><span class="page-link">{{ num }}</span></li>
                {% elif num > assignments.number|add:'-3' and num < assignments.number|add:'3' %}
                  <li class="page-item"><a class="page-link" href="?page={{ num }}{% if q %}&q={{ q|urlencode }}{% endif %}{% if status %}&status={{ status|urlencode }}{% endif %}{% if selected_subject %}&subject={{ selected_subject|urlencode }}{% endif %}">{{ num }}</a></li>
                {% endif %}
              {% endfor %}

              {% if assignments.has_next %}
                <li class="page-item">
                  <a class="page-link"
                     href="?page={{ assignments.next_page_number }}{% if q %}&q={{ q|urlencode }}{% endif %}{% if status %}&status={{ status|urlencode }}{% endif %}{% if selected_subject %}&subject={{ selected_subject|urlencode }}{% endif %}">
                    ›
                  </a>
                </li>
                <li class="page-item">
                  <a class="page-link"
                     href="?page={{ assignments.paginator.num_pages }}{% if q %}&q={{ q|urlencode }}{% endif %}{% if status %}&status={{ status|urlencode }}{% endif %}{% if selected_subject %}&subject={{ selected_subject|urlencode }}{% endif %}">
                    »
                  </a>
                </li>
              {% else %}
                 <li class="page-item disabled"><span class="page-link">›</span></li>
                 <li class="page-item disabled"><span class="page-link">»</span></li>
              {% endif %}
            </ul>
          </nav>
          {% endif %}

          {% else %}
          <div class="alert alert-secondary m-3 mb-0" role="alert"> {# Lisätty mb-0 #}
            <i class="bi bi-info-circle me-2"></i>
            {% if q %}
              Ei tehtäviä hakuehdoilla "{{ q }}".
            {% elif selected_subject %}
              Ei tehtäviä valitulla aiheella.
            {% else %}
              Ei tehtäviä näytettäväksi.
            {% endif %}
          </div>
          {% endif %}

        </div>
      </div>
    </div>
  </section>

  {% if games %}
  <section class="games-section">
    <div class="card border-primary">
      <div class="card-header bg-primary bg-opacity-10">
        <button class="btn btn-link w-100 text-start text-decoration-none p-0"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#gamesCollapse"
                aria-expanded="false" {# Oletuksena kiinni #}
                aria-controls="gamesCollapse">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
              Pelien suoritukset
              <span class="badge bg-primary ms-2">{{ games|length }}</span>
            </h5>
            <i class="bi bi-chevron-down"></i>
          </div>
        </button>
      </div>

      <div class="collapse" id="gamesCollapse"> {# Oletuksena kiinni #}
        <div class="card-body p-0">
          <div class="d-none d-md-block">
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th scope="col">Oppilas</th>
                    <th scope="col">Peli</th>
                    <th scope="col">Suoritettu</th>
                    <th scope="col">Pisteet</th>
                    <th scope="col">Tila</th>
                  </tr>
                </thead>
                <tbody>
                  {% for game in games %}
                  {% with sub=game.submissions.last %}
                  <tr>
                    <td>{{ game.student.get_full_name|default:game.student.username }}</td>
                    <td>
                      <strong>{{ game.material.title }}</strong>
                      {% if game.material.subject %}
                        <br><small class="text-muted">{{ game.material.subject }}</small>
                      {% endif %}
                    </td>
                    <td>
                      {% if sub and sub.submitted_at %}
                        {{ sub.submitted_at|date:"d.m.Y H.i" }}
                      {% else %}
                        <span class="text-muted">—</span>
                      {% endif %}
                    </td>
                    <td>
                      {% if sub and sub.score is not None %}
                        <span class="badge {% if sub.score >= 80 %}bg-success{% elif sub.score >= 50 %}bg-warning text-dark{% else %}bg-danger{% endif %}">
                          {{ sub.score|floatformat:0 }}% {# Näytetään prosentteina #}
                        </span>
                      {% else %}
                        <span class="text-muted">—</span>
                      {% endif %}
                    </td>
                    <td>
                      <span class="badge
                        {% if game.status == 'GRADED' %}bg-success
                        {% elif game.status == 'SUBMITTED' %}bg-primary {# Pelit harvoin tässä tilassa? #}
                        {% elif game.status == 'IN_PROGRESS' %}bg-warning text-dark
                        {% else %}bg-secondary{% endif %}">
                        {{ game.get_status_display }}
                      </span>
                    </td>
                  </tr>
                  {% endwith %}
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

          <div class="d-md-none">
            <div class="list-group list-group-flush">
              {% for game in games %}
              {% with sub=game.submissions.last %}
              <div class="list-group-item">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <div>
                    <h6 class="mb-1">{{ game.material.title }}</h6>
                    <small class="text-muted">{{ game.student.get_full_name|default:game.student.username }}</small>
                  </div>
                  <span class="badge
                    {% if game.status == 'GRADED' %}bg-success
                    {% elif game.status == 'SUBMITTED' %}bg-primary
                    {% else %}bg-secondary{% endif %}">
                    {{ game.get_status_display }}
                  </span>
                </div>

                <div class="small">
                  {% if game.material.subject %}
                    <div class="mb-1"><strong>Aihe:</strong> {{ game.material.subject }}</div>
                  {% endif %}

                  {% if sub and sub.submitted_at %}
                    <div class="mb-1"><strong>Suoritettu:</strong> {{ sub.submitted_at|date:"d.m.Y H:i" }}</div>
                  {% endif %}

                  {% if sub and sub.score is not None %}
                    <div>
                      <strong>Pisteet:</strong>
                      <span class="badge {% if sub.score >= 80 %}bg-success{% elif sub.score >= 50 %}bg-warning text-dark{% else %}bg-danger{% endif %}">
                        {{ sub.score|floatformat:0 }}%
                      </span>
                    </div>
                  {% endif %}
                </div>
              </div>
              {% endwith %}
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
  {% else %} {# Jos ei pelejä ollenkaan #}
    {% if not q and not selected_subject %} {# Näytä vain jos ei ole aktiivisia suodattimia #}
    <div class="alert alert-secondary" role="alert">
      Ei pelisuorituksia näytettäväksi.
    </div>
    {% endif %}
  {% endif %}

</div>
{% endblock %}