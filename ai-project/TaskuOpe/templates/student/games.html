{% extends 'partials/base.html' %}
{% block title %}Pelit{% endblock %}

{% block content %}
<div class="container-fluid">

  <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
    <h1 class="h2 mb-0"> Pelit</h1>
    <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left me-1"></i> Etusivulle
    </a>
  </div>
  
  <!-- Suodatin -->
  <form method="get" class="row g-2 align-items-end p-3 rounded mb-4 border">
    <div class="col-md-4">
      <label for="subject-filter" class="form-label fw-bold">Suodata aiheen mukaan</label>
      <select name="subject" id="subject-filter" class="form-select">
        <option value="">Kaikki aiheet</option>
        {% for subject in subjects %}
          <option value="{{ subject }}" {% if subject == selected_subject %}selected{% endif %}>
            {{ subject }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-8 d-flex gap-2">
      <button type="submit" class="btn btn-primary">Suodata</button>
      <a href="{% url 'student_games' %}" class="btn btn-outline-secondary">Tyhjennä</a>
    </div>
  </form>

  {# Uudet pelit #}
  <section class="student-section stack-flow mb-4">
    <h2 class="h5 mb-2"> Uudet pelit</h2>
    <div class="student-cards">
      {% for a in assigned %}
        <article class="card shadow-sm student-card h-100">
          <div class="card-body d-flex flex-column">
            <h3 class="card-title h6 mb-2">
              <a href="{% url 'play_game' assignment_id=a.id %}" class="text-decoration-none">
                {{ a.material.title }}
              </a>
            </h3>
            <p class="card-text text-muted small mb-2">
              <strong>Aihe:</strong> {{ a.material.subject|default:"Ei määritetty" }}
            </p>
            <p class="card-text text-muted small mb-2">
              <i class="bi bi-person me-1"></i>{{ a.assigned_by.get_full_name|default:a.assigned_by.username }}
            </p>
            {% if a.due_at %}
              <p class="card-text small mb-2">
                <i class="bi bi-calendar-event me-1"></i>
                <span {% if a.due_at < now %}class="text-danger fw-bold"{% endif %}>
                  {{ a.due_at|date:"d.m.Y H:i" }}
                </span>
              </p>
            {% endif %}
            <div class="mt-auto">
              <a href="{% url 'play_game' assignment_id=a.id %}" class="btn btn-primary btn-sm w-100">
                Pelaa 
              </a>
            </div>
          </div>
        </article>
      {% empty %}
        <div class="alert alert-info">
          <i class="bi bi-info-circle me-2"></i>Ei uusia pelejä tällä hetkellä.
        </div>
      {% endfor %}
    </div>
  </section>

  {# Keskeneräiset pelit #}
  <section class="student-section stack-flow mb-4">
    <h2 class="h5 mb-2"> Keskeneräiset pelit</h2>
    <div class="student-cards">
      {% for a in in_progress %}
        <article class="card shadow-sm student-card h-100 border-warning">
          <div class="card-body d-flex flex-column">
            <h3 class="card-title h6 mb-2">
              <a href="{% url 'play_game' assignment_id=a.id %}" class="text-decoration-none">
                {{ a.material.title }}
              </a>
            </h3>
            <p class="card-text text-muted small mb-2">
              <strong>Aihe:</strong> {{ a.material.subject|default:"Ei määritetty" }}
            </p>
            <p class="card-text text-muted small mb-2">
              <i class="bi bi-person me-1"></i>{{ a.assigned_by.get_full_name|default:a.assigned_by.username }}
            </p>
            {% if a.due_at %}
              <p class="card-text small mb-2">
                <i class="bi bi-calendar-event me-1"></i>
                <span {% if a.due_at < now %}class="text-danger fw-bold"{% endif %}>
                  {{ a.due_at|date:"d.m.Y H:i" }}
                </span>
              </p>
            {% endif %}
            <div class="mt-auto">
              <a href="{% url 'play_game' assignment_id=a.id %}" class="btn btn-warning btn-sm w-100">
                Jatka peliä ▶
              </a>
            </div>
          </div>
        </article>
      {% empty %}
        <div class="alert alert-secondary">
          <i class="bi bi-check-circle me-2"></i>Ei keskeneräisiä pelejä.
        </div>
      {% endfor %}
    </div>
  </section>

  {# Suoritetut pelit #}
  <section class="student-section stack-flow mb-4">
    <h2 class="h5 mb-2"> Suoritetut pelit</h2>
    <div class="student-cards">
      {% for a in completed %}
        <article class="card shadow-sm student-card h-100 border-success">
          <div class="card-body d-flex flex-column">
            <h3 class="card-title h6 mb-2">
              <a href="{% url 'play_game' assignment_id=a.id %}" class="text-decoration-none">
                {{ a.material.title }}
              </a>
              <span class="badge bg-success ms-2">Suoritettu</span>
            </h3>
            <p class="card-text text-muted small mb-2">
              <strong>Aihe:</strong> {{ a.material.subject|default:"Ei määritetty" }}
            </p>
            <p class="card-text text-muted small mb-2">
              <i class="bi bi-person me-1"></i>{{ a.assigned_by.get_full_name|default:a.assigned_by.username }}
            </p>
            {% with sub=a.submissions.last %}
              {% if sub and sub.score %}
                <p class="card-text small mb-2">
                  <i class="bi bi-star-fill text-warning me-1"></i>
                  <strong>Pisteet:</strong> {{ sub.score }}
                </p>
              {% endif %}
            {% endwith %}
            <div class="mt-auto">
              <a href="{% url 'play_game' assignment_id=a.id %}" class="btn btn-success btn-sm w-100">
                Pelaa uudelleen 
              </a>
            </div>
          </div>
        </article>
      {% empty %}
        <div class="alert alert-secondary">
          <i class="bi bi-info-circle me-2"></i>Et ole vielä suorittanut yhtään peliä.
        </div>
      {% endfor %}
    </div>
  </section>

</div>
{% endblock %}