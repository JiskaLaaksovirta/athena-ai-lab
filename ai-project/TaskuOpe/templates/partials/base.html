{% load static %}
<!DOCTYPE html>
<html lang="fi" data-theme="system"> 
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}TaskuOpettaja{% endblock %}</title>

    <!-- Anti-flash script -->
    <script>
        (function() {
            try {
                var theme = localStorage.getItem('theme');
                if (theme === 'dark' || (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                } else {
                    document.documentElement.setAttribute('data-theme', 'light');
                }
            } catch (e) { /* Fails gracefully */ }
        })();
    </script>

    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    {% block extra_css %}{% endblock %}
</head>
<body>

    <div class="app-container">
        <!-- Sidebar layout -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="{% url 'dashboard' %}" style="text-decoration: none; color: inherit;"><h3>TaskuOpe</h3></a>
            </div>
            <nav class="sidebar-nav">
                <a href="{% url 'dashboard' %}" class="nav-link active"><span class="nav-icon">&#127968;</span><span class="nav-text">Etusivu</span></a>
                <a href="#" class="nav-link"><span class="nav-icon">&#128101;</span><span class="nav-text">Oppilaat</span></a>
            </nav>
            <div class="sidebar-footer">
                <div class="theme-switcher">
                    <button id="theme-light" title="Vaalea tila">&#9728;</button>
                    <button id="theme-dark" title="Tumma tila">&#127769;</button>
                    <button id="theme-system" title="Järjestelmän oletus">&#128187;</button>
                </div>
            </div>
        </aside>

        <!-- Content wrapper and header -->
        <div class="content-wrapper">
            <header class="main-header">
                <div class="user-info">
                    {% if user.is_authenticated %}
                        <span>Hei, {{ user.get_full_name|default:user.username }}!</span>
                        <a href="{% url 'ulos' %}">Kirjaudu ulos</a>
                    {% else %}
                        <a href="{% url 'kirjaudu' %}">Kirjaudu</a>
                    {% endif %}
                </div>
            </header>
            
            <main class="main-content">
                {% include "partials/messages.html" %}
                {% block content %}
                {% endblock %}
            </main>
        </div>
    </div>

    <!-- ================================================= -->
    <!--    CORRECT, COMBINED SCRIPT                     -->
    <!-- ================================================= -->
    <script>
        // A single listener that runs once the entire HTML page is loaded.
        document.addEventListener('DOMContentLoaded', () => {

            // --- Block 1: Theme Switcher Logic ---
            const htmlElement = document.documentElement;
            const lightBtn = document.getElementById('theme-light');
            const darkBtn = document.getElementById('theme-dark');
            const systemBtn = document.getElementById('theme-system');

            const setThemeOnClick = (theme) => {
                localStorage.setItem('theme', theme);
                if (theme === 'system') {
                    const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
                    htmlElement.setAttribute('data-theme', systemTheme);
                } else {
                    htmlElement.setAttribute('data-theme', theme);
                }
            };

            // Make sure the buttons exist before adding listeners to them
            if (lightBtn && darkBtn && systemBtn) {
                lightBtn.addEventListener('click', () => setThemeOnClick('light'));
                darkBtn.addEventListener('click', () => setThemeOnClick('dark'));
                systemBtn.addEventListener('click', () => setThemeOnClick('system'));
            }


            // --- Block 2: Auto-hiding Messages Logic ---
            const messageAlerts = document.querySelectorAll('.messages .alert');
            if (messageAlerts.length > 0) {
                setTimeout(() => {
                    messageAlerts.forEach(alert => {
                        // Add a fade-out effect for a smoother disappearance
                        alert.style.transition = 'opacity 0.5s ease';
                        alert.style.opacity = '0';
                        setTimeout(() => alert.remove(), 500); // Remove from DOM after the fade animation
                    });
                }, 5000); // Disappear after 5 seconds
            }
            
        });
    </script>
</body>
</html>